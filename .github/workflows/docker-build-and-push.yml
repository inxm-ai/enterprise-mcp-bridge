name: Docker Image CI

on:
  push:
    branches: [ "main" ]
    tags: [ "*" ] # Trigger on tag pushes

permissions:
  contents: write
  packages: write 
  id-token: write

env:
  IMAGE_NAME: enterprise-mcp-bridge
  PYTHON_VERSIONS: '["3.11","3.12"]'
  DEFAULT_PYTHON_VERSION: "3.11"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        python-version: ${{ fromJSON(env.PYTHON_VERSIONS) }}

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # Add this step to set up Docker Buildx with a more capable driver
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest,enable=${{ github.ref == 'refs/heads/main' && matrix.python-version == env.DEFAULT_PYTHON_VERSION }} # Tag 'latest' only for the default Python version on main
            type=raw,value=latest-${{ matrix.python-version }},enable=${{ github.ref == 'refs/heads/main' }} # Tag latest per Python version on main
            type=ref,event=tag,suffix=-${{ matrix.python-version }} # Tag with the Git tag and Python version if a tag is pushed

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile 
          push: true 
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            PYTHON_VERSION=${{ matrix.python-version }}
          cache-from: type=gha # Enable build cache from GitHub Actions
          cache-to: type=gha,mode=max # Save build cache to GitHub Actions 
          outputs: type=registry
          platforms: linux/amd64,linux/arm64

  release:
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/')

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: 'true'

      - name: Install jq
        run: sudo apt-get install -y jq

      - name: Get the previous tag
        id: prev-tag
        run: |
          set -e
          git fetch --tags
          CURRENT_TAG="${GITHUB_REF#refs/tags/}"
          TAGS=$(git tag --sort=-creatordate)
          PREV_TAG=$(echo "$TAGS" | grep -v "^$CURRENT_TAG$" | head -n 1)
          echo "Current tag: $CURRENT_TAG"
          echo "Previous tag: $PREV_TAG"
          echo "PREV_TAG=$PREV_TAG" >> $GITHUB_ENV

      - name: Get commits since last tag
        id: commits
        run: |
          set -e
          if [ -n "${{ env.PREV_TAG }}" ]; then
            echo "Getting commits since ${{ env.PREV_TAG }}"
            git log ${{ env.PREV_TAG }}..HEAD --oneline > commits.txt
          else
            echo "Getting all commits"
            git log --oneline > commits.txt
          fi
          echo "COMMITS=$(jq -R -s -c 'split("\n") | map(select(. != ""))' commits.txt)" >> $GITHUB_ENV

      - name: Create Release
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const tagName = context.ref.replace('refs/tags/', '');
            const commits = JSON.parse(process.env.COMMITS);
            const versions = JSON.parse(process.env.PYTHON_VERSIONS);
            const imageBase = `ghcr.io/${context.repo.owner}/${process.env.IMAGE_NAME}`;
            const dockerImageLinks = versions.map((version) => {
              const imageRef = `${imageBase}:${tagName}-${version}`;
              return `- [${imageRef}](https://${imageRef})`;
            });
            console.log('Creating release for tag:', tagName);
            console.log('Docker image links:', dockerImageLinks);
            console.log('Commits since last tag:', commits);
            const releaseBody = [
              `### Docker images`,
              ...dockerImageLinks,
              '',
              '### Commits since last tag',
              ...commits
            ].join('\n');
            await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: tagName,
              name: `Release ${tagName}`,
              body: releaseBody,
              draft: false,
              prerelease: false
            });
