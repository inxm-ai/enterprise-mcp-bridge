services:
  keycloak:
    image: quay.io/keycloak/keycloak:25.0.2
    command: >
      start-dev --import-realm --hostname="auth.inxm.local" --https-port=443 --proxy=edge --hostname-strict=false --hostname-strict-https=false --hostname-strict-backchannel=false
    environment:
      KEYCLOAK_ADMIN: ${KEYCLOAK_ADMIN:-admin}
      KEYCLOAK_ADMIN_PASSWORD: ${KEYCLOAK_ADMIN_PASSWORD:-admin}
      KC_FEATURES: token-exchange,hostname
      KEYCLOAK_IMPORT: /opt/keycloak/data/import/realm-inxm.json
    volumes:
      - ./keycloak/realm-export:/opt/keycloak/data/import
    ports:
      - "8080:8080"
    healthcheck:
      test: ["CMD-SHELL", "/bin/sh -c 'exec 3<> /dev/tcp/localhost/8080 || exit 1'"]
      interval: 5s
      timeout: 5s
      start_period: 10s
      retries: 30
    networks:
      - private

  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:v7.4.0
    environment:
      OAUTH2_PROXY_PROVIDER: "keycloak-oidc"
      OAUTH2_PROXY_CLIENT_ID: "frontend-client"
      OAUTH2_PROXY_CLIENT_SECRET: "this-is-not-a-secret"
      OAUTH2_PROXY_COOKIE_SECRET: "1234567890abcdef"
      OAUTH2_PROXY_COOKIE_SECURE: "false"
      OAUTH2_PROXY_REDIRECT_URL: "https://inxm.local/oauth2/callback"
      OAUTH2_PROXY_UPSTREAMS: "http://app-nginx:3099/"
      OAUTH2_PROXY_EMAIL_DOMAINS: "*"
      OAUTH2_PROXY_OIDC_ISSUER_URL: "https://auth.inxm.local/realms/inxm"
      OAUTH2_PROXY_SKIP_PROVIDER_BUTTON: "true"
    ports:
      - "3000:3000"
    depends_on:
      keycloak:
        condition: service_healthy
      app-nginx:
        condition: service_healthy
      application-ingress:
        condition: service_healthy
    command:
      - "--http-address=0.0.0.0:3000"
      - "--cookie-secure=false"
      - "--upstream-timeout=30s"
      - "--ssl-insecure-skip-verify"
    networks:
      - private

  app-nginx:
    image: nginx:latest
    volumes:
      - ./nginx/app-nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "3099:3099"
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:3099/ || exit 1"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
    depends_on:
      - app-frontend
      - app-mcp-rest
    networks:
      - private

  app-frontend:
    image: node:22-alpine
    working_dir: /usr/src/app
    command: sh -c "npx --yes http-server -p 3001 ."
    volumes:
      - ./web:/usr/src/app:ro
    depends_on:
      - app-mcp-rest
    ports:
      - "3001:3001"
    labels:
      - "oauth2-proxy.enable=true"
    networks:
      - private
  
  app-mcp-rest:
    image: inxm-ai/mcp-rest-server:latest
    environment:
      MCP_SERVER_COMMAND: npx -y @softeria/ms-365-mcp-server --org-mode
      OAUTH_ENV: MS365_MCP_OAUTH_TOKEN
      AUTH_PROVIDER: keycloak
      AUTH_BASE_URL: http://keycloak:8080
      KEYCLOAK_REALM: inxm
      KEYCLOAK_PROVIDER_ALIAS: ms365
      MCP_BASE_PATH: /api/mcp/m365
    depends_on:
      keycloak:
        condition: service_healthy
    ports:
      - "3002:8000"
    labels:
      - "oauth2-proxy.enable=true"
    networks:
      - private

  application-ingress:
    image: nginx:latest
    volumes:
      - ./nginx/ingress-nginx.conf:/etc/nginx/nginx.conf:ro
      - ./dev-local-certs/auth.inxm.local.crt:/etc/nginx/certs/auth.inxm.local.crt:ro
      - ./dev-local-certs/auth.inxm.local.key:/etc/nginx/certs/auth.inxm.local.key:ro
      - ./dev-local-certs/inxm.local.crt:/etc/nginx/certs/inxm.local.crt:ro
      - ./dev-local-certs/inxm.local.key:/etc/nginx/certs/inxm.local.key:ro
    ports:
      - "443:443"
    depends_on:
      keycloak:
        condition: service_healthy
    healthcheck:
      test: ["CMD-SHELL", "curl -k --resolve auth.inxm.local:443:127.0.0.1 https://auth.inxm.local:443/realms/inxm || exit 1"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 30s
    networks:
      default: {}
      private:
        aliases:
          - inxm.local
          - auth.inxm.local

networks:
  default:
    name: mcp-rest-demo-net
  private:
    name: mcp-rest-private-net
